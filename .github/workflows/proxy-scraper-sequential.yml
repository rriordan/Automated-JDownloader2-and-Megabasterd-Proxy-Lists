name: Proxy Scraper - Sequential

on:
  schedule:
    # Run every 6 hours (at 00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      proxy_types:
        description: 'Proxy types to scrape (comma-separated: socks5,socks4,http or "all")'
        required: true
        default: 'all'
        type: string

jobs:
  scrape-proxies-sequential:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      timeout-minutes: 5

    - name: Determine proxy types to run
      id: proxy-types
      run: |
        INPUT="${{ github.event.inputs.proxy_types || 'all' }}"
        if [ "$INPUT" = "all" ]; then
          echo "types=socks5,socks4,http" >> $GITHUB_OUTPUT
        else
          echo "types=$INPUT" >> $GITHUB_OUTPUT
        fi

    - name: Run proxy scraper for each type sequentially
      run: |
        IFS=',' read -ra TYPES <<< "${{ steps.proxy-types.outputs.types }}"

        for proxy_type in "${TYPES[@]}"; do
          echo "🚀 Processing $proxy_type proxies..."

          timeout 1800 python proxy_scraper.py --proxy-type "$proxy_type" || echo "⚠️  Timeout for $proxy_type"

          if [ -f proxylist.jdproxies ]; then
            echo "✅ Generated proxy list for $proxy_type"
            mv proxylist.jdproxies "proxylist-$proxy_type.jdproxies"
          else
            echo "❌ No proxy list generated for $proxy_type"
          fi

          # Small delay between types
          sleep 10
        done
      timeout-minutes: 75

    - name: Upload all proxy lists as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: proxy-lists-all-${{ github.run_number }}
        path: proxylist-*.jdproxies
        retention-days: 7
        if-no-files-found: ignore

    - name: Commit and push all proxy lists
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Pull latest changes first
        git pull origin ${{ github.ref_name }}

        # Add all generated proxy files
        git add proxylist-*.jdproxies

        if git diff --cached --quiet; then
          echo "ℹ️  No changes to commit"
        else
          # Count files being committed
          file_count=$(git diff --cached --name-only | wc -l)
          echo "📝 Committing $file_count proxy list file(s)..."

          git commit -m "Update proxy lists - $(date '+%Y-%m-%d %H:%M UTC') [$file_count files]"
          git push origin ${{ github.ref_name }}
          echo "✅ Successfully pushed all proxy lists"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      timeout-minutes: 5
