name: Complete Proxy Scraper - With Test Mode

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      proxy_types:
        description: 'Proxy types to scrape'
        required: true
        default: 'all'
        type: choice
        options: [all, http, socks4, socks5]
      test_mode:
        description: 'Enable test mode (3 sources only)'
        required: false
        default: false
        type: boolean

jobs:
  scrape-proxies:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    concurrency:
      group: proxy-scraper
      cancel-in-progress: false

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install uvloop || echo "uvloop not available"

    - name: Run proxy scraper
      run: |
        PROXY_TYPE="${{ github.event.inputs.proxy_types || 'all' }}"
        TEST_MODE="${{ github.event.inputs.test_mode || 'false' }}"

        if [ "$TEST_MODE" = "true" ]; then
          echo "ğŸ§ª Running in TEST MODE"
          timeout 1800 python complete_proxy_scraper.py --proxy-type "$PROXY_TYPE" --test-mode
        else
          echo "ğŸš€ Running in PRODUCTION MODE" 
          timeout 5400 python complete_proxy_scraper.py --proxy-type "$PROXY_TYPE"
        fi
      timeout-minutes: 85

    - name: Verify Output folder and files
      run: |
        echo "ğŸ“ Checking Output folder contents..."

        if [ -d "Output" ]; then
          echo "âœ… Output folder exists"
          echo "ğŸ“Š Files in Output folder:"
          ls -la Output/ | grep -E '\.(jdproxies|txt|json)$' || echo "No proxy files found"

          # Count files including reports
          jd_files=$(ls Output/*.jdproxies 2>/dev/null | wc -l)
          mb_files=$(ls Output/*.txt 2>/dev/null | wc -l)
          report_files=$(ls Output/*.json 2>/dev/null | wc -l)
          total_files=$((jd_files + mb_files + report_files))

          echo "ğŸ“ˆ File summary:"
          echo "   â€¢ JDownloader2 files: $jd_files"
          echo "   â€¢ MegaBasterd files: $mb_files"
          echo "   â€¢ Report files: $report_files"
          echo "   â€¢ Total files: $total_files"

          # Show file sizes
          if [ $total_files -gt 0 ]; then
            echo "ğŸ“‹ File sizes:"
            for file in Output/*.jdproxies Output/*.txt Output/*.json; do
              if [ -f "$file" ]; then
                size=$(wc -c < "$file" 2>/dev/null || echo "0")
                lines=$(wc -l < "$file" 2>/dev/null || echo "0")
                echo "   â€¢ $(basename "$file"): $size bytes, $lines lines"
              fi
            done
          fi

          # Show performance summary if available
          if [ -f "Output/scraping_summary.txt" ]; then
            echo ""
            echo "ğŸ“ˆ Performance Summary:"
            if grep -q "Total Valid Proxies:" Output/scraping_summary.txt; then
              grep "Total Valid Proxies:" Output/scraping_summary.txt | sed 's/^/   /'
            fi
            if grep -q "Total Duration:" Output/scraping_summary.txt; then
              grep "Total Duration:" Output/scraping_summary.txt | sed 's/^/   /'
            fi
            if grep -q "Success Rate:" Output/scraping_summary.txt; then
              grep "Success Rate:" Output/scraping_summary.txt | sed 's/^/   /'
            fi
          fi
        else
          echo "âŒ Output folder not found"
          echo "Creating empty Output folder for artifacts..."
          mkdir -p Output
          echo "No proxy files were generated" > Output/generation_failed.txt
        fi

    - name: Upload proxy files as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: proxy-lists-${{ github.event.inputs.test_mode == 'true' && 'test' || 'production' }}-${{ github.run_number }}
        path: Output/
        retention-days: 7
        if-no-files-found: warn

    - name: Enhanced git operations with conflict resolution
      run: |
        echo "ğŸ”§ Configuring git with enhanced conflict resolution..."

        # Configure git identity
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - Proxy Scraper"
        git config --local pull.rebase false
        git config --local merge.ours.driver true

        echo "ğŸ“¡ Fetching latest changes from remote..."
        git fetch origin ${{ github.ref_name }}

        echo "ğŸ”„ Attempting smart merge strategy..."

        # Check if we're behind remote
        LOCAL=$(git rev-parse HEAD)
        REMOTE=$(git rev-parse origin/${{ github.ref_name }})

        if [ "$LOCAL" != "$REMOTE" ]; then
          echo "ğŸ“Š Repository state: Local branch is behind remote"
          echo "   Local HEAD:  $LOCAL"
          echo "   Remote HEAD: $REMOTE"

          # Strategy 1: Try to pull with merge strategy favoring new files
          echo "ğŸ”„ Strategy 1: Attempting pull with auto-merge..."

          # Create a .gitattributes file to handle Output folder merges
          echo "Output/*.jdproxies merge=ours" >> .gitattributes
          echo "Output/*.txt merge=ours" >> .gitattributes  
          echo "Output/*.json merge=ours" >> .gitattributes

          git add .gitattributes

          if git pull origin ${{ github.ref_name }} --no-edit; then
            echo "âœ… Successfully pulled with auto-merge"
          else
            echo "âš ï¸ Auto-merge failed, using hard reset strategy..."

            # Strategy 2: Reset to remote and re-add our Output folder
            echo "ğŸ”„ Strategy 2: Hard reset to remote + re-add Output..."

            # Backup our Output folder
            cp -r Output Output.backup 2>/dev/null || echo "No Output to backup"

            # Hard reset to remote
            git reset --hard origin/${{ github.ref_name }}

            # Restore our Output folder
            if [ -d "Output.backup" ]; then
              rm -rf Output
              mv Output.backup Output
              echo "âœ… Restored Output folder after reset"
            fi
          fi
        else
          echo "âœ… Repository state: Local branch is up to date"
        fi

        echo "ğŸ“ Adding Output folder to git..."
        git add Output/

        # Check if there are changes to commit
        if git diff --cached --quiet; then
          echo "â„¹ï¸ No changes to commit"
          exit 0
        fi

        # Count files being committed
        file_count=$(git diff --cached --name-only | wc -l)
        echo "ğŸ“ Preparing to commit $file_count file(s)"

        # Show what's being committed
        echo "ğŸ“‹ Files being committed:"
        git diff --cached --name-only | sed 's/^/   â€¢ /'

        # Create descriptive commit message
        proxy_type="${{ github.event.inputs.proxy_types || 'all' }}"
        test_mode="${{ github.event.inputs.test_mode || 'false' }}"
        timestamp=$(date '+%Y-%m-%d %H:%M UTC')

        if [ "$test_mode" = "true" ]; then
          mode_suffix="[TEST]"
        else
          mode_suffix="[PROD]"
        fi

        # Count valid proxies from the all file if it exists
        if [ -f "Output/jdownloader_proxies_all.jdproxies" ]; then
          proxy_count=$(grep -o '"address"' Output/jdownloader_proxies_all.jdproxies | wc -l)
          commit_msg="ğŸš€ Update proxy lists ($proxy_type) $mode_suffix - $timestamp [$proxy_count proxies, $file_count files]"
        else
          commit_msg="ğŸš€ Update proxy lists ($proxy_type) $mode_suffix - $timestamp [$file_count files]"
        fi

        echo "ğŸ’¬ Commit message: $commit_msg"
        git commit -m "$commit_msg"

        echo "ğŸš€ Pushing changes to remote..."

        # Try normal push first
        if git push origin ${{ github.ref_name }}; then
          echo "âœ… Successfully pushed to repository"
        else
          echo "âš ï¸ Normal push failed, attempting force push with lease..."

          # Force push with lease (safer than regular force push)
          if git push --force-with-lease origin ${{ github.ref_name }}; then
            echo "âœ… Successfully force-pushed to repository"
          else
            echo "âŒ Force push failed. Manual intervention may be required."
            echo "This can happen with multiple concurrent workflow runs."
            exit 1
          fi
        fi

      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      timeout-minutes: 5

    - name: Workflow summary
      if: always()
      run: |
        echo "ğŸ‰ WORKFLOW SUMMARY"
        echo "==================="
        echo "ğŸ“… Run date: $(date '+%Y-%m-%d %H:%M UTC')"
        echo "ğŸ¯ Proxy type: ${{ github.event.inputs.proxy_types || 'all' }}"
        echo "ğŸ§ª Test mode: ${{ github.event.inputs.test_mode || 'false' }}"
        echo "ğŸ“ Output folder: Output/"
        echo "ğŸ”§ Script used: complete_proxy_scraper.py"

        if [ "${{ github.event.inputs.test_mode || 'false' }}" = "true" ]; then
          echo "âš¡ Mode: TEST (3 sources, fast validation)"
          echo "â±ï¸ Expected time: 2-8 minutes"
        else
          echo "âš¡ Mode: PRODUCTION (70+ sources, full validation)"
          echo "â±ï¸ Expected time: 10-30 minutes"
        fi

        echo ""
        echo "ğŸš€ Active Optimizations:"
        echo "   â€¢ uvloop Event Loop (30-50% faster)"
        echo "   â€¢ Optimized TCPConnector (15-25% improvement)"
        echo "   â€¢ Parallel Source Fetching (60-80% faster)"
        echo "   â€¢ Pre-validation Filtering (30-50% fewer tests)"

        if [ -d "Output" ]; then
          file_count=$(ls Output/*.jdproxies Output/*.txt Output/*.json 2>/dev/null | wc -l || echo "0")
          echo "ğŸ“Š Files generated: $file_count"
          echo "ğŸ“¦ Artifact: proxy-lists-${{ github.event.inputs.test_mode == 'true' && 'test' || 'production' }}-${{ github.run_number }}"

          # Show optimization results if available
          if [ -f "Output/scraping_summary.txt" ]; then
            echo ""
            echo "ğŸ“ˆ Results:"
            if grep -q "Total Valid Proxies:" Output/scraping_summary.txt; then
              grep "Total Valid Proxies:" Output/scraping_summary.txt | sed 's/^/   /'
            fi
            if grep -q "Total Duration:" Output/scraping_summary.txt; then  
              grep "Total Duration:" Output/scraping_summary.txt | sed 's/^/   /'
            fi
            if grep -q "Success Rate:" Output/scraping_summary.txt; then
              grep "Success Rate:" Output/scraping_summary.txt | sed 's/^/   /'
            fi
          fi

          echo ""
          echo "ğŸ”— Download the proxy files from the Actions tab artifacts"
          echo "ğŸ”— Or check your repository for committed files"
        else
          echo "âŒ No Output folder found - check logs for errors"
        fi

        echo ""
        echo "ğŸ¯ Expected Output (when successful):"
        echo "   â€¢ Output/jdownloader_proxies_all.jdproxies"
        echo "   â€¢ Output/jdownloader_proxies_http.jdproxies"
        echo "   â€¢ Output/jdownloader_proxies_socks4.jdproxies"
        echo "   â€¢ Output/jdownloader_proxies_socks5.jdproxies"
        echo "   â€¢ Output/megabasterd_proxies_all.txt"
        echo "   â€¢ Output/megabasterd_proxies_http.txt"
        echo "   â€¢ Output/megabasterd_proxies_socks4.txt"
        echo "   â€¢ Output/megabasterd_proxies_socks5.txt"
        echo "   â€¢ Output/scraping_report.json"
        echo "   â€¢ Output/scraping_summary.txt"
        echo ""
        echo "ğŸ”„ Next scheduled run: $(date -d '+6 hours' '+%Y-%m-%d %H:%M UTC')"

        if [ "${{ github.event.inputs.test_mode || 'false' }}" = "true" ]; then
          echo ""
          echo "ğŸ’¡ TIP: Uncheck test mode for full production run with all sources"
        fi
